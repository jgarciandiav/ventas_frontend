<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiTiendas - Administrador</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/jpg" href="images/logo.jpg">
    <style>
        /* Estilos adicionales para mejorar la experiencia */
        .no-products {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 18px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px;
            font-style: italic;
        }
        
        .product-price.low {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .buy-btn.small {
            padding: 6px 10px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .price-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-top: 4px;
        }
        
        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f0f0f0;
            display: block;
        }

        .product-image[src="images/default.jpg"] {
            height: 100px;
            object-fit: contain;
        }
        
        /* Estilos para el datatable */
        .datatable-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .datatable {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .datatable th, .datatable td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .datatable th {
            background-color: #00b4db;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .datatable tr:hover {
            background-color: #f5f5f5;
        }

        .datatable tfoot td {
            font-weight: bold;
            background-color: #e3f2fd;
            border-top: 2px solid #00b4db;
        }

        .highlight-row {
            background-color: #e8f5e9 !important;
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0% { background-color: #e8f5e9; }
            100% { background-color: transparent; }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="sidebar">
        <div class="logo">
            <h1>MultiTiendas</h1>
            <p>Sistema de gesti√≥n</p>
        </div>
        
        <div class="menu-item" onclick="toggleSubmenu('submenu1')">
            Electrodom√©sticos y Art√≠culos del hogar
        </div>
        <div class="submenu" id="submenu1">
            <div class="submenu-item" onclick="filterProducts('electrodomesticos')">Electrodom√©sticos</div>
            <div class="submenu-item" onclick="filterProducts('articulos-hogar')">Art√≠culos de hogar</div>
        </div>

        <div class="menu-item" onclick="toggleSubmenu('submenu2')">
            Dulces y Regalos
        </div>
        <div class="submenu" id="submenu2">
            <div class="submenu-item" onclick="filterProducts('dulces')">Dulces</div>
            <div class="submenu-item" onclick="filterProducts('confituras')">Confituras</div>
            <div class="submenu-item" onclick="filterProducts('regalos')">Regalos</div>
        </div>

        <div class="menu-item" onclick="toggleSubmenu('submenu3')">
            Juguetes
        </div>
        <div class="submenu" id="submenu3">
            <div class="submenu-item" onclick="filterProducts('juguetes')">Juguetes</div>
        </div>

        <div class="menu-item" onclick="showWarehouseProducts()">
            Productos del Almacenero
        </div>
        
        <div class="menu-item" onclick="showSoldProducts()">
            Ver productos vendidos
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="top-bar-left">
                <select class="category-dropdown" id="categoryDropdown" onchange="filterProductsFromDropdown(this.value)" aria-label="Filtrar productos por categor√≠a">
                    <option value="">Todos los productos</option>
                    <option value="electrodomesticos">Electrodom√©sticos</option>
                    <option value="articulos-hogar">Art√≠culos de hogar</option>
                    <option value="dulces">Dulces</option>
                    <option value="confituras">Confituras</option>
                    <option value="regalos">Regalos</option>
                    <option value="juguetes">Juguetes</option>
                </select>
            </div>
            
            <div class="top-bar-right">
                <div class="user-dropdown">
                    <button class="top-btn" id="userBtn">
                        üë§ <span id="userInfo">Administrador</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="logoutBtn">üö™ Cerrar Sesi√≥n</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div id="productsSection" style="display: none;">
                <h3 class="category-title" id="categoryTitle">Todos los Productos</h3>
                <div class="products-grid" id="productsGrid"></div>
            </div>

            <div id="warehouseSection" class="hidden">
                <h3 class="category-title">Productos del Almacenero</h3>
                <div class="products-grid" id="warehouseProductsGrid"></div>
            </div>
            
            <div id="soldProductsSection" class="hidden">
                <h3 class="category-title">üìä Productos Vendidos - Resumen</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <label for="dateFilter">Filtrar por fecha: </label>
                        <input type="date" id="dateFilter">
                        <button class="buy-btn" onclick="filterSoldProductsByDate()" style="margin-left: 10px;">Filtrar</button>
                        <button class="buy-btn secondary" onclick="resetDateFilter()" style="margin-left: 10px;">Limpiar</button>
                    </div>
                    <button class="buy-btn" onclick="exportToCSV()" style="margin-left: 10px;">üì• Exportar a CSV</button>
                </div>
                <div class="datatable-container">
                    <table class="datatable" id="soldProductsTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Tipo</th>
                                <th>Cantidad Total</th>
                                <th>Precio Unitario</th>
                                <th>Importe Total</th>
                                <th>√öltima Venta</th>
                            </tr>
                        </thead>
                        <tbody id="soldProductsBody">
                            <!-- Los datos se cargar√°n din√°micamente -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"><strong>TOTALES:</strong></td>
                                <td id="totalQuantity">0</td>
                                <td></td>
                                <td id="totalAmount">S/ 0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="decorative-circles">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // ‚úÖ Verificaci√≥n de sesi√≥n
        const token = localStorage.getItem('auth_token');
        const rol = localStorage.getItem('rol');
        const username = localStorage.getItem('username');

        if (!token || !rol || rol !== 'admin') {
            alert('Acceso denegado. Inicia sesi√≥n como administrador.');
            window.location.href = 'login.html';
        }
        document.getElementById('userInfo').textContent = username || 'Administrador';

        // ‚úÖ Solo allUsers (allProducts ya est√° en script.js)
        let allUsers = [];

        // ‚úÖ Funci√≥n para ocultar todas las secciones
        function hideAllSections() {
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('warehouseSection').style.display = 'none';
            document.getElementById('soldProductsSection').classList.add('hidden');
            document.getElementById('userManagementSection')?.parentElement?.classList.add('hidden');
        }

        // ‚úÖ Cargar datos al iniciar
        async function loadDashboard() {
            hideAllSections();
            document.getElementById('productsSection').style.display = 'block';
            document.getElementById('categoryTitle').textContent = 'Todos los Productos';
            
            try {
                // Cargar productos (usamos allProducts de script.js)
                await loadProductsFromAPI();
                
                // Cargar usuarios
                const res = await fetch('http://127.0.0.1:8000/api/users/', {
                    headers: { 'Authorization': `Token ${token}` }
                });
                if (!res.ok) throw new Error(await res.text());
                allUsers = await res.json();

                // Mostrar productos por defecto
                filterProducts('');
            } catch (err) {
                alert(`‚ùå Error: ${err.message}`);
                console.error(err);
            }
        }

        // ‚úÖ Filtrar productos (reutiliza allProducts de script.js)
        function filterProducts(category) {
            hideAllSections();
            document.getElementById('productsSection').style.display = 'block';
            
            const grid = document.getElementById('productsGrid');
            const title = document.getElementById('categoryTitle');
            const dropdown = document.getElementById('categoryDropdown');
            
            const names = { 
                electrodomesticos: 'Electrodom√©sticos', 
                'articulos-hogar': 'Art√≠culos del Hogar', 
                dulces: 'Dulces', 
                confituras: 'Confituras', 
                regalos: 'Regalos', 
                juguetes: 'Juguetes' 
            };
            if (category) dropdown.value = category;
            title.textContent = names[category] || 'Todos los Productos';

            // ‚úÖ Filtrar SOLO productos con precio v√°lido (que se pueden vender)
            let filtered = category 
                ? allProducts.filter(p => 
                    p.tipoproducto === category && 
                    p.precio !== undefined && 
                    p.precio !== null && 
                    parseFloat(p.precio) > 0
                ) 
                : allProducts.filter(p => 
                    p.precio !== undefined && 
                    p.precio !== null && 
                    parseFloat(p.precio) > 0
                );

            // ‚úÖ Manejar caso cuando no hay productos con precio
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="no-products">No hay productos con precio para esta categor√≠a</div>';
                return;
            }

            // ‚úÖ Renderizar productos con conversi√≥n segura de precios
            grid.innerHTML = filtered.map(p => {
                const price = p.precio !== undefined && p.precio !== null ? parseFloat(p.precio) : 0;
                return `
                <div class="product-card">
                    <img src="http://127.0.0.1:8000${p.imagen || '/media/default.jpg'}" 
                         alt="${p.nombreproducto}" class="product-image"
                         onerror="this.src='images/default.jpg'">
                    <div class="product-info">
                        <div class="product-name">${p.nombreproducto}</div>
                        <div class="product-price">Precio/ ${price.toFixed(2)}</div>
                        <div class="product-stock ${p.stock < 5 ? 'low' : ''}">Stock: ${p.stock}</div>
                        <button class="buy-btn small" onclick="editPrice(${p.id}, '${p.nombreproducto}', ${price})">üí∞ Editar Precio</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ‚úÖ Editar precio
        function editPrice(productId, name, currentPrice) {
            const newPrice = prompt(`Nuevo precio para "${name}"\nActual: S/ ${currentPrice.toFixed(2)}`, currentPrice);
            if (newPrice === null) return;
            const priceNum = parseFloat(newPrice);
            if (isNaN(priceNum) || priceNum <= 0) return alert('Precio inv√°lido');

            fetch(`http://127.0.0.1:8000/api/almacen/${productId}/update-precio/`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ precio: priceNum }) // ‚úÖ Usa el campo correcto de tu modelo
            })
            .then(r => r.json())
            .then(() => {
                alert('‚úÖ Precio actualizado');
                // ‚úÖ Actualizar allProducts global
                const product = allProducts.find(p => p.id === productId);
                if (product) product.precio = priceNum;
                filterProducts(document.getElementById('categoryDropdown').value);
            })
            .catch(err => {
                alert(`‚ùå Error: ${err.message}`);
                console.error(err);
            });
        }

        // ‚úÖ Mostrar productos del almac√©n (precio = 0)
        function showWarehouseProducts() {
            hideAllSections();
            document.getElementById('warehouseSection').style.display = 'block';
            document.getElementById('warehouseSection').classList.remove('hidden');
            document.getElementById('categoryTitle').textContent = 'Productos del Almacenero';
            
            const grid = document.getElementById('warehouseProductsGrid');
            
            // ‚úÖ Mostrar SOLO productos con precio 0 (los que el almacenero agreg√≥)
            const warehouseProducts = allProducts.filter(p => 
                p.precio !== undefined && 
                p.precio !== null && 
                parseFloat(p.precio) === 0
            );

            // ‚úÖ Manejar caso cuando no hay productos sin precio
            if (warehouseProducts.length === 0) {
                grid.innerHTML = '<div class="no-products">No hay productos sin precio asignado</div>';
                return;
            }

            // ‚úÖ Renderizar productos con campos correctos de TU MODELO
            grid.innerHTML = warehouseProducts.map(p => {
                const price = p.precio !== undefined && p.precio !== null ? parseFloat(p.precio) : 0;
                
                return `
                <div class="product-card">
                    <img src="http://127.0.0.1:8000${p.imagen || '/media/default.jpg'}" 
                         alt="${p.nombreproducto}" class="product-image"
                         onerror="this.src='images/default.jpg'">
                    <div class="product-info">
                        <div class="product-name">${p.nombreproducto}</div>
                        <div class="product-category">Tipo: ${p.tipoproducto}</div>
                        <div class="product-category">Categor√≠a: ${p.categoria}</div>
                        <div class="product-price ${price === 0 ? 'low' : ''}">
                            ${price === 0 ? '<span class="price-warning">‚ö†Ô∏è Sin precio asignado</span>' : `Precio: S/ ${price.toFixed(2)}`}
                        </div>
                        <div class="product-stock ${p.stock < 5 ? 'low' : ''}">Stock: ${p.stock}</div>
                        <div class="product-expiry">Vence: ${new Date(p.fechavencimiento).toLocaleDateString()}</div>
                        ${price === 0 ? `
                            <button class="buy-btn small" onclick="editPrice(${p.id}, '${p.nombreproducto}', ${price})">
                                üí∞ Asignar Precio
                            </button>
                        ` : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        // ‚úÖ Mostrar productos vendidos
        function showSoldProducts() {
            hideAllSections();
            document.getElementById('soldProductsSection').classList.remove('hidden');
            document.getElementById('categoryTitle').textContent = 'üìä Productos Vendidos - Resumen';
            
            // Cargar todas las ventas
            loadSoldProductsData();
        }

        // ‚úÖ Cargar datos de productos vendidos
        async function loadSoldProductsData(date = null) {
            try {
                // ‚úÖ URL CORRECTA para listar ventas
                let url = 'http://127.0.0.1:8000/api/ventas/list/';
                if (date) {
                    url += `?fecha=${date}`;
                    document.getElementById('dateFilter').value = date;
                }

                const res = await fetch(url, {
                    headers: { 'Authorization': `Token ${token}` }
                });
                
                if (!res.ok) throw new Error(await res.text());
                
                const ventas = await res.json();
                displaySoldProducts(ventas);
            } catch (err) {
                alert(`‚ùå Error al cargar ventas: ${err.message}`);
                console.error(err);
            }
        }

        // ‚úÖ Filtrar por fecha
        function filterSoldProductsByDate() {
            const date = document.getElementById('dateFilter').value;
            if (date) {
                loadSoldProductsData(date);
            } else {
                loadSoldProductsData();
            }
        }

        // ‚úÖ Resetear filtro de fecha
        function resetDateFilter() {
            document.getElementById('dateFilter').value = '';
            loadSoldProductsData();
        }

        // ‚úÖ Mostrar los datos en la tabla
        function displaySoldProducts(ventas) {
            const tbody = document.getElementById('soldProductsBody');
            const totalQuantityEl = document.getElementById('totalQuantity');
            const totalAmountEl = document.getElementById('totalAmount');
            
            // Agrupar ventas por producto
            const productsMap = {};
            
            ventas.forEach(venta => {
                const productId = venta.producto;
                const productName = venta.producto_nombre;
                const categoria = venta.categoria || 'N/A';
                const tipo = venta.tipoproducto || 'N/A';
                const price = parseFloat(venta.precio_unitario || venta.precio_total / venta.cantidad);
                const quantity = parseInt(venta.cantidad);
                const importe = price * quantity;
                const fecha = venta.fecha;
                
                if (!productsMap[productId]) {
                    productsMap[productId] = {
                        id: productId,
                        nombre: productName,
                        categoria: categoria,
                        tipo: tipo,
                        precio_unitario: price,
                        cantidad_total: 0,
                        importe_total: 0,
                        ultima_venta: fecha
                    };
                }
                
                // Actualizar totales
                productsMap[productId].cantidad_total += quantity;
                productsMap[productId].importe_total += importe;
                
                // Actualizar √∫ltima venta (la m√°s reciente)
                if (new Date(fecha) > new Date(productsMap[productId].ultima_venta)) {
                    productsMap[productId].ultima_venta = fecha;
                }
            });
            
            // Convertir a array y ordenar por importe total (descendente)
            const productsArray = Object.values(productsMap).sort((a, b) => b.importe_total - a.importe_total);
            
            // Calcular totales generales
            let totalQuantity = 0;
            let totalAmount = 0;
            
            productsArray.forEach(p => {
                totalQuantity += p.cantidad_total;
                totalAmount += p.importe_total;
            });
            
            // Mostrar totales
            totalQuantityEl.textContent = totalQuantity;
            totalAmountEl.textContent = `S/ ${totalAmount.toFixed(2)}`;
            
            // Renderizar tabla
            if (productsArray.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            No hay productos vendidos ${document.getElementById('dateFilter').value ? 'en esta fecha' : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = productsArray.map(product => `
                <tr class="highlight-row">
                    <td><strong>${product.nombre}</strong></td>
                    <td>${product.categoria}</td>
                    <td>${product.tipo}</td>
                    <td style="color: #00b4db; font-weight: bold;">${product.cantidad_total}</td>
                    <td>S/ ${product.precio_unitario.toFixed(2)}</td>
                    <td style="color: #e74c3c; font-weight: bold;">S/ ${product.importe_total.toFixed(2)}</td>
                    <td>${new Date(product.ultima_venta).toLocaleDateString()}</td>
                </tr>
            `).join('');
            
            // Remover la clase de highlight despu√©s de 2 segundos
            setTimeout(() => {
                document.querySelectorAll('.highlight-row').forEach(row => {
                    row.classList.remove('highlight-row');
                });
            }, 2000);
        }

        // ‚úÖ Exportar a CSV
        function exportToCSV() {
            const table = document.getElementById('soldProductsTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length === 0) {
                alert('‚ö†Ô∏è No hay datos para exportar');
                return;
            }
            
            let csv = 'Producto,Categor√≠a,Tipo,Cantidad Total,Precio Unitario,Importe Total,√öltima Venta\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach((cell, index) => {
                    if (index < 7) { // Solo las primeras 7 columnas
                        let text = cell.textContent.trim();
                        // Eliminar s√≠mbolos de moneda y formato
                        text = text.replace('S/ ', '').replace(/,/g, '');
                        rowData.push(`"${text}"`);
                    }
                });
                
                csv += rowData.join(',') + '\n';
            });
            
            // A√±adir totales
            csv += '\n';
            csv += '"TOTALES GENERALES:","","",';
            csv += `"${document.getElementById('totalQuantity').textContent}"`;
            csv += ',"",';
            csv += `"${document.getElementById('totalAmount').textContent.replace('S/ ', '')}"`;
            csv += ',""';
            
            // Crear enlace de descarga
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `ventas_resumen_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Datos exportados a CSV exitosamente');
        }

        // ‚úÖ Gesti√≥n de usuarios
        function showUserManagement() {
            hideAllSections();
            const contentArea = document.querySelector('.content-area');
            if (!document.getElementById('userManagementSection')) {
                contentArea.innerHTML = `
                    <div id="userManagementSection">
                        <h3 class="category-title">üë• Gesti√≥n de Usuarios</h3>
                        
                        <!-- Formulario de registro de staff -->
                        <div class="product-card" style="margin-bottom: 20px;">
                            <div class="product-info">
                                <h4>üìù Registrar Nuevo Usuario (Staff)</h4>
                                <div class="form-group" style="margin: 10px 0;">
                                    <label>Usuario</label>
                                    <input type="text" id="newUsername" placeholder="Nombre de usuario" required>
                                </div>
                                <div class="form-group" style="margin: 10px 0;">
                                    <label>Email</label>
                                    <input type="email" id="newEmail" placeholder="correo@ejemplo.com" required>
                                </div>
                                <div class="form-group" style="margin: 10px 0;">
                                    <label>Contrase√±a</label>
                                    <input type="password" id="newPassword" placeholder="Contrase√±a (m√≠n. 6 caracteres)" required minlength="6">
                                </div>
                                <div class="form-group" style="margin: 10px 0;">
                                    <label>Rol</label>
                                    <select id="newRol" required>
                                        <option value="">Seleccione un rol</option>
                                        <option value="admin">Administrador</option>
                                        <option value="almacenero">Almacenero</option>
                                    </select>
                                </div>
                                <button class="buy-btn" onclick="registerStaff()" style="width: 100%; margin-top: 10px;">
                                    ‚úÖ Registrar Usuario
                                </button>
                                <div class="error-message" id="staffError" style="margin-top: 10px; display: none;"></div>
                            </div>
                        </div>

                        <!-- Lista de usuarios -->
                        <button class="buy-btn" onclick="loadDashboard()">‚Üê Volver</button>
                        <div class="products-grid" id="usersGrid"></div>
                    </div>
                `;
            }
            document.getElementById('userManagementSection').parentElement.classList.remove('hidden');
            displayUsers();
        }

        function displayUsers() {
            const grid = document.getElementById('usersGrid');
            const roles = { admin: 'Administrador', almacenero: 'Almacenero', usuario: 'Cliente' };
            grid.innerHTML = allUsers.map(u => `
                <div class="product-card">
                    <div class="product-info">
                        <div class="product-name">üë§ ${u.username} ${u.is_active ? '' : '(üîí inactivo)'}</div>
                        <div class="product-category">Email: ${u.email || 'N/A'}</div>
                        <div class="product-category">Rol: ${roles[u.rol] || u.rol}</div>
                        <select onchange="changeRole(${u.id}, this.value)" style="width:100%; margin:5px 0;">
                            <option value="admin" ${u.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                            <option value="almacenero" ${u.rol === 'almacenero' ? 'selected' : ''}>Almacenero</option>
                            <option value="usuario" ${u.rol === 'usuario' ? 'selected' : ''}>Cliente</option>
                        </select>
                        <button class="buy-btn small ${u.is_active ? 'secondary' : ''}" 
                                onclick="toggleStatus(${u.id}, ${u.is_active})">
                            ${u.is_active ? 'üîí Desactivar' : 'üîì Activar'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ‚úÖ Registrar staff (admin/almacenero)
        async function registerStaff() {
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPassword').value;
            const rol = document.getElementById('newRol').value;
            const errorEl = document.getElementById('staffError');

            if (!username || !email || !password || !rol) {
                showError('Todos los campos son requeridos', errorEl);
                return;
            }

            if (password.length < 6) {
                showError('La contrase√±a debe tener al menos 6 caracteres', errorEl);
                return;
            }

            if (!['admin', 'almacenero'].includes(rol)) {
                showError('Rol inv√°lido. Solo admin o almacenero.', errorEl);
                return;
            }

            try {
                const res = await fetch('http://127.0.0.1:8000/api/register-staff/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password, rol })
                });

                const data = await res.json();

                if (res.ok) {
                    alert('‚úÖ Usuario registrado exitosamente');
                    // Actualizar lista
                    allUsers.push(data);
                    displayUsers();
                    // Limpiar formulario
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newEmail').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('newRol').value = '';
                    errorEl.style.display = 'none';
                } else {
                    throw new Error(data.error || data.detail || 'Error desconocido');
                }
            } catch (err) {
                showError(err.message, errorEl);
                console.error('Error al registrar staff:', err);
            }
        }

        function showError(message, element) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        async function changeRole(userId, newRole) {
            if (!confirm('¬øCambiar rol?')) return;
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/users/${userId}/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rol: newRole })
                });
                if (!res.ok) throw new Error(await res.text());
                const user = allUsers.find(u => u.id === userId);
                if (user) user.rol = newRole;
                displayUsers();
                alert('‚úÖ Rol actualizado');
            } catch (err) {
                alert(`‚ùå Error: ${err.message}`);
            }
        }

        async function toggleStatus(userId, wasActive) {
            const newStatus = !wasActive;
            if (!confirm(`¬ø${newStatus ? 'Activar' : 'Desactivar'}?`)) return;
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/users/${userId}/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });
                if (!res.ok) throw new Error(await res.text());
                const user = allUsers.find(u => u.id === userId);
                if (user) user.is_active = newStatus;
                displayUsers();
                alert(`‚úÖ ${newStatus ? 'Activado' : 'Desactivado'}`);
            } catch (err) {
                alert(`‚ùå Error: ${err.message}`);
            }
        }

        // ‚úÖ Eventos
        function filterProductsFromDropdown(value) {
            filterProducts(value);
        }

        function toggleSubmenu(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('active');
        }

        document.getElementById('userBtn')?.addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('userDropdown').classList.toggle('active');
        });

        document.addEventListener('click', function() {
            document.getElementById('userDropdown').classList.remove('active');
        });

        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            if (confirm('¬øDesea cerrar sesi√≥n?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        });

        // ‚úÖ A√±adir bot√≥n gesti√≥n usuarios + iniciar
        window.addEventListener('load', () => {
            // A√±adir bot√≥n din√°micamente
            const sidebar = document.querySelector('.sidebar');
            const lastItem = Array.from(sidebar.children).find(el => 
                el.textContent?.includes('Ver productos vendidos')
            );
            if (lastItem) {
                const btn = document.createElement('div');
                btn.className = 'menu-item';
                btn.textContent = 'üë• Gesti√≥n de Usuarios';
                btn.onclick = showUserManagement;
                lastItem.after(btn);
            }
            
            // A√±adir evento para la tecla Enter en el filtro de fecha
            document.getElementById('dateFilter')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterSoldProductsByDate();
                }
            });
            
            loadDashboard();
        });
    </script>
</body>
</html>