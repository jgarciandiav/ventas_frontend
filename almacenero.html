<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiTiendas - Almacenero</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAP//AP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=">
    <style>
        /* Estilos para previsualizaci√≥n de imagen */
        #imagePreview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="sidebar">
        <div class="logo">
            <h1>MultiTiendas</h1>
            <p>Sistema de gesti√≥n</p>
        </div>
        
        <div class="menu-item-simple" id="menuAddProduct">
            Agregar Productos a la Tienda
        </div>
        <div class="menu-item-simple" id="menuViewProducts">
            Ver Productos Agregados
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="top-bar-left">
                <h2 id="pageTitle">Panel de Almacenero</h2>
            </div>
            
            <div class="top-bar-right">
                <div class="user-dropdown">
                    <button class="top-btn" id="userBtn">
                        üë§ <span id="userInfo">Almacenero</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" id="logoutBtn">üö™ Cerrar Sesi√≥n</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area" id="contentArea">
            <div class="welcome-message" id="welcomeMessage">
                <h2>Bienvenido al Panel de Almacenero</h2>
                <p>Selecciona una opci√≥n del men√∫ para comenzar</p>
            </div>

            <div id="addProductSection" class="hidden">
                <h3 class="category-title">Agregar/Actualizar Producto</h3>
                <form id="productForm" class="product-form" enctype="multipart/form-data">
                    <div class="form-group">                        
                        <label for="productName">Nombre del Producto</label>
                        <input type="text" id="productName" name="nombreproducto" placeholder="Ej: Arroz 1kg" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productType">Tipo de Producto</label>
                        <select id="productType" name="tipoproducto" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="electrodomesticos">Electrodom√©sticos</option>
                            <option value="articulos-hogar">Art√≠culos de hogar</option>
                            <option value="dulces">Dulces</option>
                            <option value="confituras">Confituras</option>
                            <option value="regalos">Regalos</option>
                            <option value="juguetes">Juguetes</option>
                            <option value="alimentos">Alimentos</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="productCategory">Categor√≠a</label>
                        <select id="productCategory" name="categoria" required>
                            <option value="">Seleccione una categor√≠a</option>
                            <option value="Electrodomesticos y Articulos del hogar">Electrodom√©sticos y Art√≠culos del hogar</option>
                            <option value="Dulces y Regalos">Dulces y Regalos</option>
                            <option value="Juguetes">Juguetes</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="productStock">Stock Inicial</label>
                        <input type="number" id="productStock" name="stock" min="1" placeholder="Ej: 10" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productExpiryDate">Fecha de Vencimiento</label>
                        <input type="date" id="productExpiryDate" name="fechavencimiento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="productImage">Imagen del Producto (opcional)</label>
                        <input type="file" id="productImage" name="imagen" accept="image/*">
                        <div id="imagePreview"></div>
                    </div>
                    
                    <button type="submit" class="buy-btn">‚úÖ Guardar Producto</button>
                    <button type="button" class="buy-btn secondary" id="btnViewProducts">
                        üëÄ Ver Productos Existentes
                    </button>
                </form>
            </div>

            <div id="viewProductsSection" class="hidden">
                <h3 class="category-title">Productos en Almac√©n</h3>
                <div class="products-grid" id="addedProductsGrid"></div>
            </div>
        </div>

        <div class="decorative-circles">
            <div class="circle circle1"></div>
            <div class="circle circle2"></div>
            <div class="circle circle3"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // ‚úÖ Verificaci√≥n de sesi√≥n
        const token = localStorage.getItem('auth_token');
        const rol = localStorage.getItem('rol');
        const username = localStorage.getItem('username');

        if (!token || !rol || rol !== 'almacenero') {
            alert('Acceso denegado. Inicia sesi√≥n como almacenero.');
            window.location.href = 'login.html';
        }
        document.getElementById('userInfo').textContent = username || 'Almacenero';

        // Variables globales
        allProducts = [];
        let currentEditingId = null; // ‚úÖ Variable global para controlar edici√≥n

        // ‚úÖ Previsualizaci√≥n de imagen
        document.getElementById('productImage')?.addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Previsualizaci√≥n">`;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // ‚úÖ Funciones
        function showAddProductForm(isEditing = false) {
            document.getElementById('welcomeMessage').classList.add('hidden');
            document.getElementById('addProductSection').classList.remove('hidden');
            document.getElementById('viewProductsSection').classList.add('hidden');
            
            if (!isEditing) {
                // ‚úÖ Limpiar formulario COMPLETAMENTE al crear nuevo
                document.getElementById('productForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                currentEditingId = null;
                document.getElementById('pageTitle').textContent = 'Agregar Producto';
            }
        }

        function showViewProducts() {
            document.getElementById('welcomeMessage').classList.add('hidden');
            document.getElementById('addProductSection').classList.add('hidden');
            document.getElementById('viewProductsSection').classList.remove('hidden');
            document.getElementById('pageTitle').textContent = 'Productos en Almac√©n';
            displayProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch('http://127.0.0.1:8000/api/almacen/', {
                    headers: { 'Authorization': `Token ${token}` }
                });
                if (!res.ok) throw new Error(await res.text());
                allProducts = await res.json();
                showViewProducts();
            } catch (err) {
                alert(`‚ùå Error: ${err.message}`);
                console.error(err);
            }
        }

        function displayProducts() {
            const grid = document.getElementById('addedProductsGrid');
            grid.innerHTML = allProducts.map(p => `
                <div class="product-card">
                    <div class="product-info">
                        <div class="product-name">${p.nombreproducto}</div>
                        <div class="product-category">Tipo: ${p.tipoproducto}</div>
                        <div class="product-category">Categor√≠a: ${p.categoria}</div>
                        ${p.imagen ? 
                            `<img src="http://127.0.0.1:8000${p.imagen}" alt="${p.nombreproducto}" class="product-image" style="width:100%; height:150px; object-fit:cover; margin:10px 0;">` : 
                            ''
                        }
                        <div class="product-price">Precio: S/ ${parseFloat(p.precio).toFixed(2)}</div>
                        <div class="product-stock ${p.stock < 5 ? 'low' : ''}">Stock: ${p.stock}</div>
                        <div class="product-expiry">Vence: ${new Date(p.fechavencimiento).toLocaleDateString()}</div>
                        <div class="product-actions">
                            <button class="buy-btn small" onclick="updateStock(${p.id})">
                                ‚ûï Actualizar Stock
                            </button>
                            <button class="buy-btn small secondary" onclick="editProduct(${p.id})">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStock(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const newStock = prompt(`Ingrese nuevo stock para "${product.nombreproducto}"\nStock actual: ${product.stock}`, product.stock);
            if (newStock === null) return;

            const stockNum = parseInt(newStock);
            if (isNaN(stockNum) || stockNum < 0) {
                alert('Stock debe ser un n√∫mero entero ‚â• 0');
                return;
            }

            fetch(`http://127.0.0.1:8000/api/almacen/${productId}/update-stock/`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stock: stockNum })
            })
            .then(r => r.json())
            .then(data => {
                alert('‚úÖ Stock actualizado');
                product.stock = stockNum;
                displayProducts();
            })
            .catch(err => {
                alert(`‚ùå Error: ${err.message}`);
                console.error(err);
            });
        }

        function editProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            // ‚úÖ Limpiar formulario antes de rellenar
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            
            // ‚úÖ Rellenar campos con valores seguros
            document.getElementById('productName').value = product.nombreproducto || '';
            document.getElementById('productType').value = product.tipoproducto || '';
            document.getElementById('productCategory').value = product.categoria || '';
            document.getElementById('productStock').value = product.stock || 1;

            // ‚úÖ Manejo robusto de fecha
            let fechaStr = '';
            if (product.fechavencimiento) {
                if (typeof product.fechavencimiento === 'string') {
                    if (product.fechavencimiento.includes('T')) {
                        fechaStr = product.fechavencimiento.split('T')[0];
                    } else {
                        fechaStr = product.fechavencimiento;
                    }
                } else if (product.fechavencimiento instanceof Date) {
                    fechaStr = product.fechavencimiento.toISOString().split('T')[0];
                } else {
                    fechaStr = product.fechavencimiento;
                }
            }
            document.getElementById('productExpiryDate').value = fechaStr;

            // ‚úÖ Previsualizaci√≥n de imagen
            if (product.imagen) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="http://127.0.0.1:8000${product.imagen}" alt="Previsualizaci√≥n" style="max-width:200px; max-height:200px; border-radius:8px;">`;
            }

            // ‚úÖ Establecer ID de edici√≥n (USANDO VARIABLE GLOBAL)
            currentEditingId = productId;

            // ‚úÖ Mostrar formulario en modo edici√≥n
            showAddProductForm(true);
            document.getElementById('pageTitle').textContent = `‚úèÔ∏è Editando: ${product.nombreproducto || 'Producto'}`;
        }

        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ‚úÖ FormData para subir imagen
            const formData = new FormData(this);

            // ‚úÖ Validaci√≥n
            if (!formData.get('nombreproducto')) return alert('Nombre es obligatorio');
            if (!formData.get('tipoproducto')) return alert('Tipo es obligatorio');
            if (!formData.get('categoria')) return alert('Categor√≠a es obligatoria');
            if (!formData.get('stock') || parseInt(formData.get('stock')) < 1) return alert('Stock debe ser ‚â• 1');
            if (!formData.get('fechavencimiento')) return alert('Fecha de vencimiento es obligatoria');

            try {
                // ‚úÖ Usar VARIABLE GLOBAL para determinar si es edici√≥n
                const isEditing = currentEditingId !== null;
                const url = isEditing 
                    ? `http://127.0.0.1:8000/api/almacen/${currentEditingId}/`
                    : 'http://127.0.0.1:8000/api/almacen/create/';
                const method = isEditing ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Token ${token}`
                    },
                    body: formData
                });

                let data;
                try {
                    data = await res.json();
                } catch (jsonErr) {
                    console.error('Respuesta no es JSON:', await res.text());
                    throw new Error('Respuesta del servidor no es JSON');
                }

                if (!res.ok) {
                    throw new Error(data.error || data.detail || `HTTP ${res.status}`);
                }

                if (isEditing) {
                    // ‚úÖ Actualizar producto existente en la lista local
                    const index = allProducts.findIndex(p => p.id == currentEditingId);
                    if (index !== -1) {
                        allProducts[index] = data;
                    }
                    alert('‚úÖ Producto actualizado');
                } else {
                    // ‚úÖ Agregar nuevo producto a la lista local
                    allProducts.push(data);
                    alert('‚úÖ Producto creado');
                }
                
                // ‚úÖ Limpiar y mostrar lista actualizada
                currentEditingId = null;
                showViewProducts();
                
            } catch (err) {
                console.error('Error:', err);
                alert(`‚ùå ${err.message}`);
            }
        });

        // ‚úÖ Eventos
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();

            document.getElementById('menuAddProduct')?.addEventListener('click', () => {
                // ‚úÖ Siempre limpiar al crear nuevo producto
                currentEditingId = null;
                showAddProductForm();
            });
            
            document.getElementById('menuViewProducts')?.addEventListener('click', showViewProducts);
            document.getElementById('btnViewProducts')?.addEventListener('click', showViewProducts);

            document.getElementById('userBtn')?.addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('userDropdown').classList.toggle('active');
            });
            document.addEventListener('click', () => {
                document.getElementById('userDropdown').classList.remove('active');
            });
            document.getElementById('logoutBtn')?.addEventListener('click', logout);
        });

        function logout() {
            if (confirm('¬øDesea cerrar sesi√≥n?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>